<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../olos-param/olos-param.html">

<!--
olos-oscillator is a signal oscillating between -1 and +1, with 0 as no amplitude.

It oscillates at a frequency (cycles per second) that we perceive as sound if it is fast
enough (above 40Hz) or a rhythm if it is low enough (<20Hz).

##### Example


@element olos-oscillator
@blurb 
@status alpha
@homepage http://olosmusic.github.io/olos-oscillator
-->
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="olos-oscillator">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [hidden] {
      display: none !important;
    }
    [layout] {
      @apply(--layout);
    }
    [layout][horizontal] {
      @apply(--layout-horizontal);
    }
    [layout][center] {
      @apply(--layout-center);
    }
  </style>
  <link rel="stylesheet" type="text/css" href="olos-oscillator.css">
  <template>

    <div class="olos-container">

      <div class="top-container">
          <paper-dropdown-menu id="osc-drop" label="Oscillator Type" icon="menu" class="dropdown-trigger">
            <paper-menu selected="{{oscType}}" on-iron-select="setType" attr-for-selected="label" class="menu dropdown-content">
                <paper-item label="sine"> <iron-icon src="./icons/sine_.svg"></iron-icon>Sine</paper-item>
                <paper-item label="triangle"> <iron-icon src="./icons/triangle_.svg"></iron-icon>Triangle</paper-item>
                <paper-item label="square"> <iron-icon src="./icons/square_.svg"></iron-icon> Square</paper-item>
                <paper-item label="sawtooth"> <iron-icon src="./icons/sawtooth_.svg"></iron-icon> Sawtooth</paper-item>
                <paper-item label="custom"> <iron-icon src=""></iron-icon> Custom</paper-item>
<!--                 <paper-item label="pwm"> <iron-icon src="./icons/sawtooth_.svg"></iron-icon> Pulse Width Modulation</paper-item>
                <paper-item label="pulse"> <iron-icon src="./icons/sawtooth_.svg"></iron-icon> Pulse</paper-item> -->
            </paper-menu>
          </paper-dropdown-menu>
          <paper-tooltip position="right" for="osc-drop">Toggle Oscillator Type </paper-tooltip>


          <!-- <paper-icon-button on-click="_toggleStart" id="start" src="icons/play.png" hidden=""></paper-icon-button> -->
          <label class="sync-label">LFO / Sync BPM<paper-toggle-button id="sync-toggle" on-click="_toggleMode" ></paper-toggle-button></label>

      </div>




        <div class$="{{modeClass}}">

          <div class="no-sync">
            <olos-param id="frequencyParam"></olos-param>
            <div id="freq-param" center="" horizontal="" layout="horizonal">
              <label>Freq</label>
              <paper-slider pin="true" id="freqSlider" min="1" max="1000" immediate-value="{{freq}}" on-click="stopProp" on-immediate-value-change="setFreq" on-change="setFreq" editable="" style="width:100%" label="freq"></paper-slider>
            </div>
            <paper-tooltip for="freq-param" position="top">Frequency in Hertz (cycles per second)</paper-tooltip>

            <olos-param id="detuneParam"></olos-param>
            <div id="detune-param" center="" horizontal="" layout="horizontal">
              <label>Detune</label>
              <paper-slider pin="true" id="detuneSlider" min="-1200" max="1200" default="0" step="100" immediate-value="{{detune}}" on-click="stopProp" on-immediate-value-change="setDetune" on-change="setDetune" editable="" style="width:100%"></paper-slider>
            </div>
            <paper-tooltip for="detune-param">Detune in Cents (100 cents = 1 note)</paper-tooltip>
          </div>

          <div class="sync">
            <div center="" horizontal=""><label>Frequency: </label>"<span>{{_syncedNum}}</span><span>{{_syncedUnit}}</span>" (<label></label>{{computedFreq}}<span>Hz)</span></div>

            <div id="tone-sync-freq" center="" horizontal="" layout="">
                <paper-input on-change="changeSyncedFreq" class="single-char" type="number" min="1" max="128" maxlength="3" value="{{_syncedNum}}">
                </paper-input>
                <paper-radio-group on-paper-radio-group-changed="changeSyncedFreq" role="listbox" tabindex="0" selected="{{_syncedUnit}}">
                  <paper-radio-button name="n">n (note) </paper-radio-button>
                  <paper-radio-button name="t">t (triplet)</paper-radio-button>
                  <paper-radio-button name="m">m (measure)</paper-radio-button>
                </paper-radio-group>
            </div>
            <paper-tooltip for="tone-sync-freq">Sync to Tempo, using Tone.Time. For example "4n" is a quarter-note, "8t" is an eighth-note triplet, and "1m" is one measure.</paper-tooltip>
          </div>

        </div>

      </div> <!-- end olos-container-->
  </template>
  <script>
    (function (params) {
      Polymer({
        is: 'olos-oscillator',
        properties: {

          _syncedNum: {
            value: "4",
            type: String
          },

          _syncedUnit: {
            value: "n",
            type: String
          },

          computedFreq: {
            type: Number,
            value: undefined
          },

          // sync or not?
          modeClass: {
            value: '',
            type: String
          },

          syncTempo: {
            value: undefined,
            type: String
          },

          /**
           *  A Tone.JS Omni-Oscillator, similar
           *  to the Web Audio API Oscillator Node
           *  but with additional methods like setPartials()
           *
           *  @property toneOsc
           *  @type {Object}
           */
          toneOsc: {
            value: undefined
          },

          color: { notify: true },
          detune: {
            value: 0
          },
          freq: { 
            value: 220,
            observer: 'freqChanged'
          },
          /**
           *  AudioParam representing the frequency of the OscillatorNode in Hz
           *  
           *  @property frequencyParam
           *  @type olos-param
           */
          frequencyParam: {
            value: null,
            notify: true
          },
          /**
           *  AudioParam representing the detune of the OscillatorNode in cents
           *  where 100 cents = 1 step/note.
           *  
           *  @property detuneParam
           *  @type olos-param
           */
          detuneParam: {
            value: null,
            notify: true
          },
          height: {
            type: Number,
            value: 100,
            notify: true
          },
          oscType: {
            type: String,
            value: 'sine'
          },
          // output
          output: {
            value: null,
            notify: true
          },
          play: { notify: true },
          playing: {
            type: Boolean,
            value: false
          },
          publicMethods: {
            type: Array,
            value: function () {
              return [
                'setPartials',
                'setupFreqSlider',
                'freqUpdate',
                'detuneUpdate'
              ];
            }
          },
          rootfolder: {
            type: String,
            // value: '../olos-oscillator/',
            value: '../',
            notify: true
          },
          src: { notify: true },
          width: {
            type: Number,
            value: 100,
            notify: true
          }
        },
        // set audioParams for olos-params
        // TO DO: generate these automatically ?
        _initParams: function () {
          var self = this;
          self.frequencyParam = this.$.frequencyParam;
          self.detuneParam = this.$.detuneParam;
          self.frequencyParam.scope = self;
          self.frequencyParam.callback = function(a, b) {
            self.freqUpdate(a, b)
          };
          self.detuneParam.scope = self;
          self.detuneParam.callback = function(a, b) {
            self.detuneUpdate(a, b)
          };
          self.detuneParam.audioParam = self.toneOsc.detune;
          self.frequencyParam.audioParam = self.toneOsc.frequency;
          // self.frequencyParam = self.toneOsc.frequency;
          // self.detuneParam = self.toneOsc.detune;
        },
        setType: function (e) {
          var sel = e.target.selected;
          this.oscType = sel;

          if (this.toneOsc) {
            this.set('toneOsc.type', this.oscType);
            if (this.oscType == 'custom') {
              this.setPartials();
            }
          }
        },
        setFreq: function (e, detail) {
          var self = this;

          // only act if it was triggered by an event
          if (e) {
            e.preventDefault();
            e.stopPropagation();
            if (self.freq <= 0 || !self.toneOsc) {
              return;
            }

            if (self.modeClass !== 'synced') {
              self.toneOsc.frequency.exponentialRampToValueAtTime(self.freq, self.toneOsc.now() + 0.00000001);
            }

            self.freqChanged();
          }
        },
        setDetune: function (e, detail) {
          var self = this;
          if (e) {
            e.preventDefault();
            e.stopPropagation();
            if (!self.toneOsc) {
              return;
            }
            console.log(self.detune);
            // this.detuneChanged();
            if (self.toneOsc) {
              var now = self.toneOsc.now();
              self.toneOsc.detune.linearRampToValueAtTime(self.detune, now + 0.000001);
            }
          }
        },
        stopProp: function (e) {
          e.preventDefault();
          e.stopPropagation();
        },
        // publicly editable
        setupFreqSlider: function () {
          this.set('freqSlider.min', 0.01);
          this.set('freqSlider.max', 1200);
          this.set('freqSlider.step', 0.1);
          this.set('freqSlider.value', 220);
        },

        // called by olos-param
        /**
         *  This function is called when new values are received
         *  from a connected matrix.
         *  
         *  @method freqUpdate
         *  @param  {Array} value array of values from a matrix
         *  @param  {Number} time  audioContext time
         */
        freqUpdate: function (values, time) {
          var values = arguments[0];
          var time = arguments[1];

          for (var i = 0; i < values.length; i++) {
            if (values[i] > 0) {

              // scale frequency according to the key olos is in
              this.set('freqSlider.value', olos.scaleStep(i));

              // apply new frequency to this oscillatorNode
              this.toneOsc.frequency.setValueAtTime(this.freq, time);
            }
          }
        },
        // called by olos-param
        /**
         *  This function is called when new values are received
         *  from a connected matrix.
         *  
         *  @method detuneUpdate
         *  @param  {Array} value array of values from a matrix
         *  @param  {Number} time  audioContext time
         */
        detuneUpdate: function (value, time) {
          var value = arguments[0];
          var time = arguments[1];

          for (var i = 0; i < value.length; i++) {
            if (value[i] > 0) {
              // multiply detune values
              // this.detune = i * 100;
              console.log(i * 100);
              this.set('detuneSlider.value', i * 100);

              // apply detune to this oscillatorNode
              this.toneOsc.detune.setValueAtTime(i*100, time);
            }
          }
        },
        setPartials: function() {
          var partials = [1];
          for (var i = 0; i < 24; i++) {
              partials.push(Math.random());
          }

          this.toneOsc.partials = partials;
        },
        // + this.detune.value/12);
        freqChanged: function () {
          if (this.freq <= 0) {
            this.set('freqSlider.value', 1e-9);
            console.log('Error: Oscillator frequency must be greater than 0. Setting to 0.000001');
          }
        },
        // this.freqSlider.value = this.freq;
        _draw: function () {
        },
        // console.log('drawing ');
        // this.freqSlider.value = this.oscillatorNode.frequency.value;
        // this.detuneSliderValue = this.oscillatorNode.detune.value;
        dispose: function () {
          this.toneOsc.dispose();

          var nodes = [
            'output',
            'oscillatorNode'
          ];

          for (var i = 0; i < nodes.length; i++) {
            try {
              var node = self[nodes[i]];
              node.disconnect();
              node = null;
            } catch (e) {
            }
          }
        },
        ready: function () {
          var self = this;
          self.initUI();

          self._audioContext = audioContext;
          self.playing = false;

          self.output = audioContext.createGain();
          self._initOsc();

          self._initParams();
          self.__debug();
        },

        initUI: function() {
          this.freqSlider = this.$.freqSlider;
          this.detuneSlider = this.$.detuneSlider;
          // this.freqSlider.value = this.freq;
          this.setupFreqSlider();
        },

        __debug: function() {
          window.osc = this;
        },

        _initOsc: function() {
          var self = this;
          this.toneOsc = new Tone.OmniOscillator();

          self.toneOsc.type = this.oscType;
          self.toneOsc.frequency.value = self.freq;
          self.toneOsc.connect(self.output);
          self.toneOsc.start();

          var now = audioContext.currentTime;
          if (this.modulator) {
            this.modulator.connect(this.toneOsc.frequency);
          }

          // listen for bpm-change events from forked tone.js
          document.addEventListener('bpm-change', function(e) {
            // if synced, sync osc freq
            if (self.modeClass === 'synced') {
              self.changeSyncedFreq();
            }
          });

        },

        // sync to tempo of Tone.Transport?
        _toggleMode: function(e) {
          var className = this.$$('#sync-toggle').checked ? 'synced' : '';
          this.modeClass = className;

          if (className.length > 0) {
            this.changeSyncedFreq();
            this.toneOsc.syncFrequency();
          } else {
            // get slider value
            this.toneOsc.unsyncFrequency();
            this.toneOsc.frequency.value = this.freq;
          }
        },

        changeSyncedFreq: function() {
          var self = this;
          var freqString = this._syncedNum + this._syncedUnit;
          this.toneOsc.frequency.value = freqString;
          console.log(this.toneOsc.frequency.value);

          setTimeout(function() {
            self.computedFreq = self.toneOsc.toFrequency( freqString);
          }, 1);
        }

      });
    }());
  </script>
</dom-module>
